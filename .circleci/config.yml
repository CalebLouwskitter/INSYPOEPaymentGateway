version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:18.19
  docker-executor:
    docker:
      - image: cimg/base:current
    environment:
      DOCKER_BUILDKIT: 1

jobs:
  test-backend:
    executor: node-executor
    docker:
      - image: cimg/node:18.19
      - image: mongo:7.0
        environment:
          MONGO_INITDB_DATABASE: insy7314_test
    working_directory: ~/project/Backend
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          keys:
            - backend-deps-v1-{{ checksum "package.json" }}
            - backend-deps-v1-
      - run:
          name: Install Backend Dependencies
          command: npm install
      - save_cache:
          key: backend-deps-v1-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
                echo "MongoDB is ready"
                exit 0
              fi
              echo "Waiting for MongoDB..."
              sleep 2
            done
            echo "MongoDB failed to start"
            exit 1
          environment:
            MONGODB_URI: mongodb://localhost:27017/insy7314_test
      - run:
          name: Run Backend Tests
          command: npm test
          environment:
            MONGODB_URI: mongodb://localhost:27017/insy7314_test
            JWT_SECRET: test_jwt_secret_for_ci_pipeline
            NODE_ENV: test
      - store_test_results:
          path: ~/project/Backend/coverage
      - store_artifacts:
          path: ~/project/Backend/coverage

workflows:
  build-test-deploy:
    jobs:
      - test-backend
