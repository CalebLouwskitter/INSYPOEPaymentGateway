
# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Pipeline parameters to control optional steps (e.g., skipping tests by default)
parameters:
  run-tests:
    type: boolean
    default: false
  run-full:
    type: boolean
    default: false

# Define reusable executors
# (CircleCI, 2025)
executors:
  node-executor:
    docker:
      - image: cimg/node:18.19
  docker-executor:
    docker:
      - image: cimg/base:current
    environment:
      DOCKER_BUILDKIT: 1

# Define jobs to be invoked later in a workflow
# (CircleCI, 2025)
jobs:
  # Backend Tests
  test-backend:
    executor: node-executor
    docker:
      - image: cimg/node:18.19
      - image: mongo:latest
        environment:
          MONGO_INITDB_DATABASE: insy7314_test
    working_directory: ~/project/Backend
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          keys:
            - backend-deps-v1-{{ checksum "package.json" }}
            - backend-deps-v1-
      - run:
          name: Install Backend Dependencies
          command: npm install
      - save_cache:
          key: backend-deps-v1-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run:
          name: Wait for MongoDB
          command: |
            echo "Waiting for MongoDB on localhost:27017 ..."
            ATTEMPTS=60
            for i in $(seq 1 $ATTEMPTS); do
              # Bash TCP check; returns 0 when port is open
              if (echo > /dev/tcp/127.0.0.1/27017) >/dev/null 2>&1; then
                echo "MongoDB is accepting TCP connections"
                exit 0
              fi
              echo "[${i}/${ATTEMPTS}] MongoDB not ready yet; retrying in 2s"
              sleep 2
            done
            echo "MongoDB failed to become ready in time"
            exit 1
      - run:
          name: Run Backend Tests
          command: npm test
          environment:
            MONGODB_URI: mongodb://127.0.0.1:27017/insy7314_test
            JWT_SECRET: test_jwt_secret_for_ci_pipeline
            NODE_ENV: test
      - store_artifacts:
          path: ~/project/Backend/coverage

  # Frontend Tests
  # (CircleCI, 2025)
  test-frontend:
    executor: node-executor
    working_directory: ~/project/Frontend
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          keys:
            - frontend-deps-v1-{{ checksum "package.json" }}
            - frontend-deps-v1-
      - run:
          name: Install Frontend Dependencies
          command: npm install
      - save_cache:
          key: frontend-deps-v1-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run:
          name: Run Frontend Tests
          command: CI=true npm test -- --coverage --watchAll=false
      - store_artifacts:
          path: ~/project/Frontend/coverage

  # Build Backend
  # (CircleCI, 2025)
  build-backend:
    executor: node-executor
    working_directory: ~/project/Backend
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          keys:
            - backend-deps-v1-{{ checksum "package.json" }}
            - backend-deps-v1-
      - run:
          name: Install Backend Dependencies
          command: npm install
      - run:
          name: Verify Backend Build
          command: echo "Backend build successful"

  # Build Frontend
  # (CircleCI, 2025)
  build-frontend:
    executor: node-executor
    working_directory: ~/project/Frontend
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          keys:
            - frontend-deps-v1-{{ checksum "package.json" }}
            - frontend-deps-v1-
      - run:
          name: Install Frontend Dependencies
          command: npm install
      - run:
          name: Build Frontend
          command: npm run build
      - persist_to_workspace:
          root: ~/project/Frontend
          paths:
            - build
      - store_artifacts:
          path: ~/project/Frontend/build

  # Build Docker Images
  # (CircleCI, 2025)
  build-docker-images:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout
      - run:
          name: Build Backend Docker Image
          command: |
            docker build -t insypoe-backend:$CIRCLE_SHA1 ./Backend
            docker tag insypoe-backend:$CIRCLE_SHA1 insypoe-backend:latest
      - run:
          name: Build Frontend Docker Image
          command: |
            docker build -t insypoe-frontend:$CIRCLE_SHA1 ./Frontend
            docker tag insypoe-frontend:$CIRCLE_SHA1 insypoe-frontend:latest
      - run:
          name: Test Docker Compose Setup
          command: |
            # Create a test .env file
            echo "JWT_SECRET=test_secret_for_ci" > .env
            # Verify docker-compose file is valid (use docker compose v2)
            docker compose config
      - run:
          name: Save Docker Images
          command: |
            mkdir -p docker-cache
            docker save -o docker-cache/backend.tar insypoe-backend:latest
            docker save -o docker-cache/frontend.tar insypoe-frontend:latest
      - persist_to_workspace:
          root: .
          paths:
            - docker-cache

  # Lint Backend Code
  # (CircleCI, 2025)
  lint-backend:
    executor: node-executor
    working_directory: ~/project/Backend
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          keys:
            - backend-deps-v1-{{ checksum "package.json" }}
            - backend-deps-v1-
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Run ESLint (if configured)
          command: |
            if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
              npm run lint || echo "No lint script found, skipping"
            else
              echo "No ESLint configuration found, skipping"
            fi

  # Security Audit
  # (CircleCI, 2025)
  security-audit:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Audit Backend Dependencies
          command: |
            cd Backend
            npm audit --audit-level=moderate || true
      - run:
          name: Audit Frontend Dependencies
          command: |
            cd Frontend
            npm audit --audit-level=moderate || true

  gitleaks-scan:
    docker:
      - image: zricethezav/gitleaks:latest
    steps:
      - checkout
      - run:
          name: Scan for Secrets with Gitleaks
          command: gitleaks detect --no-git -v || true

  trivy-fs-scan:
    docker:
      - image: aquasec/trivy:0.55.1
    steps:
      - checkout
      - run:
          name: Trivy FS scan (HIGH/CRITICAL)
          command: trivy fs --exit-code 0 --severity HIGH,CRITICAL --no-progress . || true

  # Deploy job (placeholder). Replace with real deploy steps for your target.
  deploy:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Deploy (placeholder)
          command: |
            echo "Starting deploy stage..."
            echo "Workspace contents:"
            ls -la
            echo "Docker cache contents (if any):"
            ls -la docker-cache || true
            echo "TODO: Add real deploy commands (e.g., push images, helm/azd/terraform)."

# Orchestrate jobs using workflows
# (CircleCI, 2025)
workflows:
  # Build-only workflow (default): saves CI credits by not running tests
  build-only:
    jobs:
      # Run security audit first
      - security-audit
      - gitleaks-scan
      - trivy-fs-scan

      # Run linting
      - lint-backend

      # Build (no dependency on tests)
      - build-backend:
          requires:
            - lint-backend
      - build-frontend:
          requires:
            - security-audit

      # Build Docker images after all builds pass
      # (CircleCI, 2025)
      - build-docker-images:
          requires:
            - build-backend
            - build-frontend
            - security-audit

  # Optional tests workflow: only runs when run-tests=true
  tests:
    when: << pipeline.parameters.run-tests >>
    jobs:
      - security-audit
      - gitleaks-scan
      - trivy-fs-scan
      - test-backend:
          requires:
            - security-audit
            - gitleaks-scan
            - trivy-fs-scan
      - test-frontend:
          requires:
            - security-audit
            - gitleaks-scan
            - trivy-fs-scan

  # Full pipeline: Build + Test + Deploy (opt-in)
  build-test-deploy:
    when: << pipeline.parameters.run-full >>
    jobs:
      # Pre-checks
      - security-audit
      - gitleaks-scan
      - trivy-fs-scan

      # Linting
      - lint-backend

      # Tests
      - test-backend:
          requires:
            - security-audit
            - gitleaks-scan
            - trivy-fs-scan
      - test-frontend:
          requires:
            - security-audit
            - gitleaks-scan
            - trivy-fs-scan

      # Builds (after tests)
      - build-backend:
          requires:
            - test-backend
            - lint-backend
      - build-frontend:
          requires:
            - test-frontend

      # Docker images
      - build-docker-images:
          requires:
            - build-backend
            - build-frontend

      # Deploy stage
      - deploy:
          requires:
            - build-docker-images

     


